name: Update Changelog

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'docs/CHANGELOG.md'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Grouped Changelog
        run: |
          mkdir -p docs
          
          REPO_URL="https://github.com/${{ github.repository }}"
          
          # --- FIXED HEADER SECTION (SAFER METHOD) ---
          cat <<EOF > docs/CHANGELOG.md
          # Changelog

          This changelog documents notable changes to [ohmlaws.github.io](https://github.com/ohmlaws/ohmlaws.github.io).

          > For theme-level updates, refer to the Chirpy theme [changelog](https://github.com/cotes2020/jekyll-theme-chirpy/blob/master/docs/CHANGELOG.md)

          Last Updated: $(date +'%Y-%m-%d')
          EOF
          # --- END OF HEADER ---
          
          
          # 1. Fetch logs (hiding merges and bot updates)
          git log --date=short --no-merges --pretty=format:"%ad|%s|%h|%H" | grep -v "docs: update CHANGELOG.md" > commits.txt
          
          current_date=""
          
          # 2. Loop through lines
          while IFS='|' read -r date msg short_hash long_hash; do
          
            if [ "$date" != "$current_date" ]; then
              echo "" >> docs/CHANGELOG.md
              echo "## $date" >> docs/CHANGELOG.md
              current_date="$date"
            fi
            
            echo "- $msg ([$short_hash]($REPO_URL/commit/$long_hash))" >> docs/CHANGELOG.md
            
          done < commits.txt
          
          # 3. Add links to Pull Requests
          sed -i -E "s|#([0-9]+)|[#\1]($REPO_URL/pull/\1)|g" docs/CHANGELOG.md
          
          rm commits.txt

      - name: Commit & Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs: update CHANGELOG.md [skip ci]"
          file_pattern: docs/CHANGELOG.md
