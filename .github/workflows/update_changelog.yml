name: Update Changelog

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'docs/CHANGELOG.md'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Grouped Changelog
        run: |
          mkdir -p docs
          REPO_URL="https://github.com/${{ github.repository }}"
          
          # Initialize the file
          echo "# Changelog

This changelog documents notable changes to [ohmlaws.github.io](https://github.com/ohmlaws/ohmlaws.github.io).

> For theme-level updates, refer to the Chirpy theme [changelog](https://github.com/cotes2020/jekyll-theme-chirpy/blob/master/docs/CHANGELOG.md)
" > docs/CHANGELOG.md
          echo "Last Updated: $(date +'%Y-%m-%d')" >> docs/CHANGELOG.md
          
          # Fetch logs with a special separator "|"
          # Format: Date | Message | ShortHash | LongHash
          git log --date=short --pretty=format:"%ad|%s|%h|%H" > commits.txt
          
          current_date=""
          
          # Read the log line by line
          while IFS='|' read -r date msg short_hash long_hash; do
            # Skip the bot's own commit messages to keep it clean
            if [[ "$msg" == *"docs: update CHANGELOG.md"* ]]; then
              continue
            fi
          
            # If the date has changed, print a new Header
            if [ "$date" != "$current_date" ]; then
              echo "" >> docs/CHANGELOG.md
              echo "## $date" >> docs/CHANGELOG.md
              current_date="$date"
            fi
            
            # Print the commit item
            echo "- $msg ([$short_hash]($REPO_URL/commit/$long_hash))" >> docs/CHANGELOG.md
            
          done < commits.txt
          
          # Finally, add links to Pull Requests (e.g., #12 -> link)
          sed -i -E "s|#([0-9]+)|[#\1]($REPO_URL/pull/\1)|g" docs/CHANGELOG.md
          
          # Clean up temp file
          rm commits.txt

      - name: Commit & Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs: update CHANGELOG.md [skip ci]"
          file_pattern: docs/CHANGELOG.md
